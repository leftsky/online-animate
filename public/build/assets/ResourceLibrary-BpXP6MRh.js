var ie=Object.defineProperty;var de=(D,r,d)=>r in D?ie(D,r,{enumerable:!0,configurable:!0,writable:!0,value:d}):D[r]=d;var Y=(D,r,d)=>de(D,typeof r!="symbol"?r+"":r,d);import{d as ae,r as h,c as v,o as c,a as s,f as k,b as n,u as l,t as g,w as f,e as w,n as oe,F as j,j as E,k as y,g as J,l as ce,h as ue,m as pe,p as me,q as ve,s as Z,v as fe}from"./app-Dynu5tc5.js";import{_ as V}from"./Button.vue_vue_type_script_setup_true_lang-BgPnemTW.js";import{_ as W,a as q}from"./Label.vue_vue_type_script_setup_true_lang-BZ8aVwwL.js";import{_ as ge}from"./Textarea.vue_vue_type_script_setup_true_lang-DTxhneIX.js";import{_ as _e,a as he,b as ye,c as be,d as we}from"./DialogTitle.vue_vue_type_script_setup_true_lang-Bnsa-2D0.js";import{_ as xe}from"./DialogDescription.vue_vue_type_script_setup_true_lang-DtC2VvC9.js";import{u as $}from"./useToast-zrdN7exZ.js";import{_ as $e}from"./AppLayout.vue_vue_type_script_setup_true_lang-CmafWrlK.js";import{U as Ce}from"./upload-Ba6rq5iT.js";import{X as ke}from"./x-BE0BvSeC.js";import{T as Ue,P as Ie}from"./trash-2-CYySEXdi.js";import{_ as Se}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{I as ee}from"./image-DckTtAF3.js";import{U as De,P as Ve,S as Fe}from"./users-CPDw-dyN.js";import{C as te,E as Re}from"./ellipsis-vertical-Bj-pqAIa.js";import{L as ze}from"./DropdownMenuLabel.vue_vue_type_script_setup_true_lang-BagbxIyi.js";import"./index-CUUO6Z42.js";import"./DropdownMenuTrigger.vue_vue_type_script_setup_true_lang-mndLukLN.js";import"./settings-C2RLwdqr.js";import"./createLucideIcon-CZW-bvdG.js";import"./AppLogoIcon.vue_vue_type_script_setup_true_lang-C9_ic-40.js";const Te={class:"media-uploader"},Pe={class:"text-lg font-medium mb-2"},Be={class:"text-muted-foreground mb-4"},Le={key:0,class:"upload-progress mt-6"},Me={class:"space-y-2"},Ge={class:"flex-1"},je={class:"flex items-center justify-between mb-1"},Ee={class:"text-sm font-medium"},Ae={class:"text-xs text-muted-foreground"},Ne={class:"w-full bg-background rounded-full h-2"},qe={key:1,class:"uploaded-files mt-6"},Oe={class:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"},We=["src","alt"],Je={class:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center"},Qe=ae({__name:"MediaUploader",props:{type:{default:"general"},resourceId:{},onUploadComplete:{},onCreateResource:{},autoCreateResource:{type:Boolean,default:!1}},emits:["uploadComplete","uploadError"],setup(D,{expose:r,emit:d}){const b=D,m=d,U=h(),I=h(!1),S=h([]),C=h([]),Q=()=>{var u;(u=U.value)==null||u.click()},z=u=>{const a=u.target;a.files&&F(Array.from(a.files))},T=u=>{u.preventDefault(),I.value=!0},B=u=>{u.preventDefault(),I.value=!1},X=u=>{var a;u.preventDefault(),I.value=!1,(a=u.dataTransfer)!=null&&a.files&&F(Array.from(u.dataTransfer.files))},F=u=>{const a=u.filter(i=>{if(!i.type.startsWith("image/")){const{toast:_}=$();return _.error(`文件 ${i.name} 不是有效的图片格式`),!1}if(i.size>52428800){const{toast:_}=$();return _.error(`文件 ${i.name} 超过 50MB 限制`),!1}return!0});a.length!==0&&(a.forEach(i=>{const _={id:Math.random().toString(36).substr(2,9),file:i,name:i.name,size:i.size,progress:0,status:"pending"};S.value.push(_)}),p())},p=async()=>{const u=S.value.filter(a=>a.status==="pending");for(const a of u){a.status="uploading";try{const i=setInterval(()=>{a.progress<90&&(a.progress+=Math.random()*20)},200),_=new FormData;_.append("file",a.file),_.append("type","image"),_.append("folder",`media/${b.type}`);const G=await y.post("/web/api/upload",_,{headers:{"Content-Type":"multipart/form-data"}});if(clearInterval(i),a.progress=100,a.status="completed",G.data.success){const A={id:Math.random().toString(36).substr(2,9),name:a.name,filename:a.name,path:G.data.data.path,url:G.data.data.url,size:a.size,mime_type:a.file.type,extension:a.file.name.split(".").pop()||"",type:b.type,resource_id:b.resourceId,user_id:1,uploaded_at:new Date().toISOString()};if(C.value.push(A),b.autoCreateResource&&b.onCreateResource)try{await b.onCreateResource(A)}catch(O){console.error("自动创建资源失败:",O)}const{toast:H}=$();H.success(`文件 ${a.name} 上传成功`)}else throw new Error(G.data.message||"上传失败")}catch(i){a.status="error",a.error=i instanceof Error?i.message:"上传失败";const{toast:_}=$();_.error(`文件 ${a.name} 上传失败`)}}setTimeout(()=>{S.value=S.value.filter(a=>a.status!=="completed")},2e3),C.value.length>0&&(m("uploadComplete",C.value),b.onUploadComplete&&b.onUploadComplete(C.value))},L=u=>{const a=S.value.findIndex(i=>i.id===u);a>-1&&S.value.splice(a,1)},M=async u=>{try{const a=C.value.findIndex(_=>_.id===u);a>-1&&C.value.splice(a,1);const{toast:i}=$();i.success("文件已移除")}catch{const{toast:a}=$();a.error("文件移除失败")}};return r({uploadedFiles:C,clearFiles:()=>{C.value=[]}}),(u,a)=>(c(),v("div",Te,[s("div",{class:oe(["upload-dropzone",{"drag-over":I.value}]),onDrop:X,onDragover:T,onDragleave:B,onClick:Q},[n(l(Ce),{class:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),s("h3",Pe,g((u.autoCreateResource,"拖拽文件到此处")),1),s("p",Be,g(u.autoCreateResource?"支持 JPG、PNG、GIF、WebP 格式，单个文件最大 50MB，将自动创建资源":"支持 JPG、PNG、GIF、WebP 格式，单个文件最大 50MB"),1),n(l(V),{variant:"outline"},{default:f(()=>[w(g(u.autoCreateResource?"选择文件上传":"选择文件"),1)]),_:1}),s("input",{ref_key:"fileInput",ref:U,type:"file",multiple:"",accept:"image/*",class:"hidden",onChange:z},null,544)],34),S.value.length>0?(c(),v("div",Le,[a[0]||(a[0]=s("h4",{class:"font-medium mb-3"},"上传进度",-1)),s("div",Me,[(c(!0),v(j,null,E(S.value,i=>(c(),v("div",{key:i.id,class:"flex items-center gap-3 p-3 bg-muted rounded-lg"},[s("div",Ge,[s("div",je,[s("span",Ee,g(i.name),1),s("span",Ae,g(i.progress)+"%",1)]),s("div",Ne,[s("div",{class:"bg-primary h-2 rounded-full transition-all duration-300",style:ce({width:i.progress+"%"})},null,4)])]),i.status==="uploading"?(c(),J(l(V),{key:0,variant:"ghost",size:"sm",onClick:_=>L(i.id)},{default:f(()=>[n(l(ke),{class:"w-4 h-4"})]),_:2},1032,["onClick"])):k("",!0)]))),128))])])):k("",!0),C.value.length>0?(c(),v("div",qe,[a[1]||(a[1]=s("h4",{class:"font-medium mb-3"},"已上传文件",-1)),s("div",Oe,[(c(!0),v(j,null,E(C.value,i=>(c(),v("div",{key:i.id,class:"relative group"},[s("img",{src:i.url,alt:i.name,class:"w-full aspect-square object-cover rounded-lg"},null,8,We),s("div",Je,[n(l(V),{variant:"ghost",size:"sm",onClick:_=>M(i.id),class:"text-white hover:text-white hover:bg-white/20"},{default:f(()=>[n(l(Ue),{class:"w-4 h-4"})]),_:2},1032,["onClick"])])]))),128))])])):k("",!0)]))}}),se=Se(Qe,[["__scopeId","data-v-be3718d5"]]);class Xe{constructor(){Y(this,"baseUrl","/web/api")}async getScenarios(r={}){return(await y.get(`${this.baseUrl}/media-scenarios`,{params:r})).data.data}async createScenario(r){return(await y.post(`${this.baseUrl}/media-scenarios`,r)).data}async getScenario(r){return(await y.get(`${this.baseUrl}/media-scenarios/${r}`)).data}async updateScenario(r,d){return(await y.put(`${this.baseUrl}/media-scenarios/${r}`,d)).data}async deleteScenario(r){return(await y.delete(`${this.baseUrl}/media-scenarios/${r}`)).data}async getCharacters(r={}){return(await y.get(`${this.baseUrl}/media-characters`,{params:r})).data.data}async createCharacter(r){return(await y.post(`${this.baseUrl}/media-characters`,r)).data}async getCharacter(r){return(await y.get(`${this.baseUrl}/media-characters/${r}`)).data}async updateCharacter(r,d){return(await y.put(`${this.baseUrl}/media-characters/${r}`,d)).data}async deleteCharacter(r){return(await y.delete(`${this.baseUrl}/media-characters/${r}`)).data}async getItems(r={}){return(await y.get(`${this.baseUrl}/media-items`,{params:r})).data.data}async createItem(r){return(await y.post(`${this.baseUrl}/media-items`,r)).data}async getItem(r){return(await y.get(`${this.baseUrl}/media-items/${r}`)).data}async updateItem(r,d){return(await y.put(`${this.baseUrl}/media-items/${r}`,d)).data}async deleteItem(r){return(await y.delete(`${this.baseUrl}/media-items/${r}`)).data}}const R=new Xe,He={class:"min-h-screen bg-background"},Ke={class:"container mx-auto p-6"},Ye={class:"mb-6"},Ze={class:"border-b border-border"},et={class:"-mb-px flex space-x-8"},tt=["onClick"],st={class:"grid grid-cols-1 lg:grid-cols-4 gap-6"},at={class:"lg:col-span-3"},ot={class:"mb-4 flex flex-col sm:flex-row gap-4"},rt={class:"flex-1"},nt={class:"flex gap-2"},lt={class:"relative"},it={key:0,class:"absolute top-full left-0 z-50 w-full mt-1 bg-popover border border-border rounded-md shadow-lg"},dt={class:"p-1"},ct=["onClick"],ut={class:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"},pt=["onClick"],mt={class:"aspect-square bg-muted rounded-md mb-3 overflow-hidden"},vt=["src","alt"],ft={key:1,class:"w-full h-full flex items-center justify-center text-muted-foreground"},gt={class:"space-y-1"},_t={class:"font-medium text-sm text-foreground truncate"},ht={key:0,class:"text-xs text-muted-foreground"},yt={key:1,class:"text-xs text-muted-foreground truncate"},bt={class:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity"},wt={key:0,class:"text-center py-12"},xt={class:"w-16 h-16 mx-auto mb-4 bg-muted rounded-full flex items-center justify-center"},$t={class:"text-lg font-medium text-foreground mb-2"},Ct={class:"text-muted-foreground mb-4"},kt={key:0,class:"lg:col-span-1"},Ut={class:"bg-card border border-border rounded-lg p-4"},It={key:1,class:"lg:col-span-1"},St={class:"bg-card border border-border rounded-lg p-4"},Dt={class:"text-sm text-muted-foreground mb-4"},Vt={class:"space-y-2"},Ft={class:"space-y-2"},Rt={class:"space-y-2"},zt={key:0,class:"space-y-2"},Tt={class:"relative"},Pt={key:0,class:"absolute top-full left-0 z-50 w-full mt-1 bg-popover border border-border rounded-md shadow-lg"},Bt={class:"p-1"},Lt=["onClick"],Mt={key:1,class:"space-y-2"},ls=ae({__name:"ResourceLibrary",setup(D){const r=[{title:"工作台",href:"/dashboard"},{title:"资源库",href:"/resource-library"}],d=[{key:"scenarios",title:"场景库",icon:ee},{key:"characters",title:"人物库",icon:De},{key:"items",title:"物品库",icon:Ve}],b=[{value:0,label:"未知"},{value:1,label:"男性"},{value:2,label:"女性"},{value:3,label:"其他"}],m=h("scenarios"),U=h(""),I=h(""),S=h(""),C=h(""),Q=h(""),z=h(!1),T=h(!1),B=h(!1),X=h([]),F=h(!1),p=h({name:"",description:"",category:"",gender:0,age:""}),L=h([]),M=h([]),u=ue(()=>{let o=L.value.filter(e=>m.value==="scenarios"?"generation_prompt"in e:m.value==="characters"?"gender"in e:m.value==="items"?"type"in e:!1);return U.value&&(o=o.filter(e=>{var t;return e.name.toLowerCase().includes(U.value.toLowerCase())||((t=e.description)==null?void 0:t.toLowerCase().includes(U.value.toLowerCase()))})),I.value&&(o=o.filter(e=>e.category===I.value)),o}),a=()=>{const o=d.find(e=>e.key===m.value);return o?o.title.replace("库",""):""},i=()=>{const o=d.find(e=>e.key===m.value);return o?o.icon:ze},_=o=>{const e=b.find(t=>t.value===o);return e?e.label:"未知"},G=o=>{console.log("选择资源:",o)},A=o=>{I.value=o,T.value=!1,N()},H=o=>{p.value.gender=o,B.value=!1},O=o=>{X.value=o,console.log("文件上传完成:",o)},re=async o=>{try{console.log("自动创建资源:",o);let e;const t={name:"未命名",image_path:o.url,description:"",category:"",status:1};if(m.value==="scenarios"?e=await R.createScenario({...t,generation_prompt:"",tags:[]}):m.value==="items"&&(e=await R.createItem({...t,generation_prompt:"",type:"",properties:[],tags:[]})),e!=null&&e.success){const{toast:x}=$();return x.success(`已自动创建${a()}资源`),N(),e.data}}catch(e){console.error("自动创建资源失败:",e);const{toast:t}=$();t.error("自动创建资源失败")}},ne=async()=>{if(!p.value.name.trim()){const{toast:o}=$();o.error("请输入资源名称");return}F.value=!0;try{let o;if(m.value==="scenarios"?o=await R.createScenario({name:p.value.name,description:p.value.description,category:p.value.category}):m.value==="characters"?o=await R.createCharacter({name:p.value.name,description:p.value.description,category:p.value.category,gender:p.value.gender,age:p.value.age?parseInt(p.value.age):void 0}):m.value==="items"&&(o=await R.createItem({name:p.value.name,description:p.value.description,category:p.value.category})),o!=null&&o.success){const{toast:e}=$();e.success("资源添加成功"),z.value=!1,le(),N()}else{const{toast:e}=$();e.error((o==null?void 0:o.message)||"添加失败")}}catch(o){console.error("添加资源失败:",o);const{toast:e}=$();e.error("添加资源失败，请重试")}finally{F.value=!1}},le=()=>{p.value={name:"",description:"",category:"",gender:0,age:""}},N=async()=>{F.value=!0;try{const o={limit:50,offset:0,search:U.value,category:I.value,status:S.value};let e;if(m.value==="scenarios"){e=await R.getScenarios(o),L.value=e;const t=e.map(x=>x.category).filter(x=>!!x);M.value=[...new Set(t)]}else if(m.value==="characters"){const t={...o,gender:C.value};e=await R.getCharacters(t),L.value=e;const x=e.map(P=>P.category).filter(P=>!!P);M.value=[...new Set(x)]}else if(m.value==="items"){const t={...o,type:Q.value};e=await R.getItems(t),L.value=e;const x=e.map(P=>P.category).filter(P=>!!P);M.value=[...new Set(x)]}}catch(o){console.error("加载资源失败:",o);const{toast:e}=$();e.error("加载资源失败")}finally{F.value=!1}};pe([U,m],()=>{N()}),me(()=>{N()}),ve(()=>{document.removeEventListener("click",K)});const K=o=>{const e=document.querySelector(".absolute.top-full.left-0.z-50.w-full.mt-1.bg-popover.border.border-border.rounded-md.shadow-lg");e&&!e.contains(o.target)&&(T.value=!1)};return document.addEventListener("click",K),(o,e)=>(c(),J($e,{breadcrumbs:r},{default:f(()=>[s("div",He,[s("div",Ke,[e[13]||(e[13]=s("div",{class:"mb-6"},[s("h1",{class:"text-3xl font-bold text-foreground"},"资源库"),s("p",{class:"text-muted-foreground mt-2"},"管理您的场景、人物和物品资源")],-1)),s("div",Ye,[s("div",Ze,[s("nav",et,[(c(),v(j,null,E(d,t=>s("button",{key:t.key,onClick:x=>m.value=t.key,class:oe(["py-2 px-1 border-b-2 font-medium text-sm transition-colors",m.value===t.key?"border-primary text-primary":"border-transparent text-muted-foreground hover:text-foreground hover:border-border"])},[(c(),J(Z(t.icon),{class:"w-4 h-4 inline mr-2"})),w(" "+g(t.title),1)],10,tt)),64))])])]),s("div",st,[s("div",at,[s("div",ot,[s("div",rt,[n(l(W),{modelValue:U.value,"onUpdate:modelValue":e[0]||(e[0]=t=>U.value=t),placeholder:"搜索资源...",class:"max-w-md"},{prefix:f(()=>[n(l(Fe),{class:"w-4 h-4 text-muted-foreground"})]),_:1},8,["modelValue"])]),s("div",nt,[s("div",lt,[n(l(V),{variant:"outline",onClick:e[1]||(e[1]=t=>T.value=!T.value),class:"w-40 justify-between"},{default:f(()=>[w(g(I.value||"全部分类")+" ",1),n(l(te),{class:"w-4 h-4"})]),_:1}),T.value?(c(),v("div",it,[s("div",dt,[s("div",{class:"px-2 py-1.5 text-sm hover:bg-accent hover:text-accent-foreground cursor-pointer rounded",onClick:e[2]||(e[2]=t=>A(""))}," 全部分类 "),(c(!0),v(j,null,E(M.value,t=>(c(),v("div",{key:t,class:"px-2 py-1.5 text-sm hover:bg-accent hover:text-accent-foreground cursor-pointer rounded",onClick:x=>A(t)},g(t),9,ct))),128))])])):k("",!0)]),n(l(V),{onClick:e[3]||(e[3]=t=>z.value=!0),class:"whitespace-nowrap"},{default:f(()=>[n(l(Ie),{class:"w-4 h-4 mr-2"}),w(" 添加"+g(a()),1)]),_:1})])]),s("div",ut,[(c(!0),v(j,null,E(u.value,t=>(c(),v("div",{key:t.id,class:"group relative bg-card border border-border rounded-lg p-4 hover:border-primary/50 transition-all cursor-pointer",onClick:x=>G(t)},[s("div",mt,[t.image_path?(c(),v("img",{key:0,src:t.image_path,alt:t.name,class:"w-full h-full object-cover group-hover:scale-105 transition-transform"},null,8,vt)):(c(),v("div",ft,[n(l(ee),{class:"w-8 h-8"})]))]),s("div",gt,[s("h3",_t,g(t.name),1),t.category?(c(),v("p",ht,g(t.category),1)):k("",!0),t.description?(c(),v("p",yt,g(t.description),1)):k("",!0)]),s("div",bt,[n(l(V),{variant:"ghost",size:"sm",class:"h-8 w-8 p-0"},{default:f(()=>[n(l(Re),{class:"w-4 h-4"})]),_:1})])],8,pt))),128))]),u.value.length===0?(c(),v("div",wt,[s("div",xt,[(c(),J(Z(i()),{class:"w-8 h-8 text-muted-foreground"}))]),s("h3",$t,"暂无"+g(a()),1),s("p",Ct,"点击上方按钮添加您的第一个"+g(a()),1)])):k("",!0)]),m.value==="characters"?(c(),v("div",kt,[s("div",Ut,[e[11]||(e[11]=s("h3",{class:"font-medium text-foreground mb-4"},"文件管理",-1)),n(se,{type:"character",onUploadComplete:O})])])):k("",!0),m.value==="scenarios"||m.value==="items"?(c(),v("div",It,[s("div",St,[e[12]||(e[12]=s("h3",{class:"font-medium text-foreground mb-4"},"批量上传",-1)),s("p",Dt,"拖拽图片文件到此处，将自动创建"+g(a())+"资源",1),n(se,{type:m.value==="scenarios"?"scenario":"item","auto-create-resource":!0,"on-create-resource":re,onUploadComplete:O},null,8,["type"])])])):k("",!0)])]),n(l(_e),{open:z.value,"onUpdate:open":e[10]||(e[10]=t=>z.value=t)},{default:f(()=>[n(l(he),{class:"max-w-md"},{default:f(()=>[n(l(ye),null,{default:f(()=>[n(l(be),null,{default:f(()=>[w("添加"+g(a()),1)]),_:1}),n(l(xe),null,{default:f(()=>[w(" 创建新的"+g(a())+"资源 ",1)]),_:1})]),_:1}),s("form",{onSubmit:fe(ne,["prevent"]),class:"space-y-4"},[s("div",Vt,[n(l(q),{for:"name"},{default:f(()=>e[14]||(e[14]=[w("名称",-1)])),_:1,__:[14]}),n(l(W),{id:"name",modelValue:p.value.name,"onUpdate:modelValue":e[4]||(e[4]=t=>p.value.name=t),placeholder:"输入名称",required:""},null,8,["modelValue"])]),s("div",Ft,[n(l(q),{for:"description"},{default:f(()=>e[15]||(e[15]=[w("描述",-1)])),_:1,__:[15]}),n(l(ge),{id:"description",modelValue:p.value.description,"onUpdate:modelValue":e[5]||(e[5]=t=>p.value.description=t),placeholder:"输入描述",rows:"3"},null,8,["modelValue"])]),s("div",Rt,[n(l(q),{for:"category"},{default:f(()=>e[16]||(e[16]=[w("分类",-1)])),_:1,__:[16]}),n(l(W),{id:"category",modelValue:p.value.category,"onUpdate:modelValue":e[6]||(e[6]=t=>p.value.category=t),placeholder:"输入分类"},null,8,["modelValue"])]),m.value==="characters"?(c(),v("div",zt,[n(l(q),{for:"gender"},{default:f(()=>e[17]||(e[17]=[w("性别",-1)])),_:1,__:[17]}),s("div",Tt,[n(l(V),{variant:"outline",onClick:e[7]||(e[7]=t=>B.value=!B.value),class:"w-full justify-between"},{default:f(()=>[w(g(_(p.value.gender))+" ",1),n(l(te),{class:"w-4 h-4"})]),_:1}),B.value?(c(),v("div",Pt,[s("div",Bt,[(c(),v(j,null,E(b,t=>s("div",{key:t.value,class:"px-2 py-1.5 text-sm hover:bg-accent hover:text-accent-foreground cursor-pointer rounded",onClick:x=>H(t.value)},g(t.label),9,Lt)),64))])])):k("",!0)])])):k("",!0),m.value==="characters"?(c(),v("div",Mt,[n(l(q),{for:"age"},{default:f(()=>e[18]||(e[18]=[w("年龄",-1)])),_:1,__:[18]}),n(l(W),{id:"age",modelValue:p.value.age,"onUpdate:modelValue":e[8]||(e[8]=t=>p.value.age=t),type:"number",placeholder:"输入年龄"},null,8,["modelValue"])])):k("",!0),n(l(we),null,{default:f(()=>[n(l(V),{type:"button",variant:"outline",onClick:e[9]||(e[9]=t=>z.value=!1)},{default:f(()=>e[19]||(e[19]=[w("取消",-1)])),_:1,__:[19]}),n(l(V),{type:"submit",disabled:F.value},{default:f(()=>e[20]||(e[20]=[w("添加",-1)])),_:1,__:[20]},8,["disabled"])]),_:1})],32)]),_:1})]),_:1},8,["open"])])]),_:1}))}});export{ls as default};
